<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>抽签器 — 导入名字 & 随机抽取</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;--glass: rgba(255,255,255,0.04)}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;color:#e6eef6;background:linear-gradient(180deg,#071021 0%, #081322 100%)}
    .container{max-width:980px;margin:32px auto;padding:24px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    h1{margin:0 0 12px;font-size:20px;color:var(--accent)}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
    .card{background:var(--card);padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    textarea{width:100%;height:230px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit;resize:vertical}
    input[type=text], input[type=number], select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .btn{display:inline-block;padding:8px 12px;border-radius:8px;background:var(--accent);color:#042022;text-decoration:none;border:none;cursor:pointer;font-weight:600}
    .mutebtn{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .winners-list{margin-top:12px}
    .winner-pill{display:inline-block;padding:6px 10px;border-radius:999px;background:linear-gradient(90deg, rgba(6,182,212,0.12), rgba(6,182,212,0.06));margin:6px 6px 0 0;border:1px solid rgba(6,182,212,0.12)}
    .animated-slot{height:56px;display:flex;align-items:center;justify-content:center;margin-bottom:6px;border-radius:8px;background:rgba(255,255,255,0.02);font-size:18px}
    footer{margin-top:16px;color:var(--muted);font-size:13px}
    .small{font-size:12px;color:var(--muted)}
    .file-row{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
  <div class="container">
    <h1>抽签器 — 导入名字并随机抽取</h1>
    <p class="small">支持手动粘贴、CSV 导入；可选择抽取人数、导出结果、去重与复选项。页面为单文件运行，直接保存为 .html 即可本地打开。</p >

    <div class="grid">
      <div class="card">
        <label>1) 导入名字（每行一个姓名，或逗号分隔）</label>
        <textarea id="namesInput" placeholder="例如：张三\n李四\n王五 或 张三,李四,王五"></textarea>

        <div style="margin-top:10px" class="file-row">
          <input id="csvFile" type="file" accept=".csv" />
          <button class="btn" id="importCsvBtn">从 CSV 导入</button>
          <button class="mutebtn" id="clearNamesBtn">清空</button>
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)" />

        <label>2) 抽取设置</label>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <div style="flex:1">
            <label class="small">抽取人数</label>
            <input id="count" type="number" min="1" value="1" />
          </div>
          <div style="width:140px">
            <label class="small">是否去重</label>
            <select id="uniqueSelect"><option value="true">是（默认）</option><option value="false">否（允许重复）</option></select>
          </div>
        </div>

        <label class="small">额外选项</label>
        <div class="controls" style="margin-bottom:8px">
          <label class="small" style="display:flex;align-items:center;gap:8px"><input id="excludeBlank" type="checkbox" checked /> 排除空行</label>
          <label class="small" style="display:flex;align-items:center;gap:8px"><input id="shuffleBefore" type="checkbox" checked /> 抽前先打乱名单</label>
        </div>

        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="drawBtn">开始抽签</button>
          <button class="mutebtn" id="previewBtn">预览名单</button>
          <button class="mutebtn" id="exportAllBtn">导出名单 (CSV)</button>
        </div>
      </div>

      <div class="card">
        <label>3) 显示与结果</label>
        <div id="slots"></div>
        <div class="winners-list" id="winners"></div>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn" id="copyBtn">复制结果</button>
          <button class="mutebtn" id="exportWinnersBtn">导出中奖名单 (CSV)</button>
          <button class="mutebtn" id="resetBtn">重置抽奖</button>
        </div>

        <div style="margin-top:12px">
          <label class="small">日志</label>
          <pre id="log" style="max-height:140px;overflow:auto;padding:8px;background:rgba(0,0,0,0.15);border-radius:8px;color:var(--muted)"></pre>
        </div>
      </div>
    </div>

    <footer>提示：若名单很长，建议使用 CSV 导入（每行一个名字或第一列为名字）。需要在页面做其他定制（比如分组抽签或加权抽签）可以告诉我具体要求。</footer>
  </div>

<script>
(function(){
  // Helpers
  const $ = id => document.getElementById(id);
  const log = (t) => { const p = $('log'); p.textContent = new Date().toLocaleTimeString() + '  ' + t + '\n' + p.textContent; };

  // Elements
  const namesInput = $('namesInput');
  const csvFile = $('csvFile');
  const importCsvBtn = $('importCsvBtn');
  const clearNamesBtn = $('clearNamesBtn');
  const countInput = $('count');
  const uniqueSelect = $('uniqueSelect');
  const excludeBlank = $('excludeBlank');
  const shuffleBefore = $('shuffleBefore');
  const drawBtn = $('drawBtn');
  const previewBtn = $('previewBtn');
  const exportAllBtn = $('exportAllBtn');
  const slots = $('slots');
  const winnersDiv = $('winners');
  const copyBtn = $('copyBtn');
  const exportWinnersBtn = $('exportWinnersBtn');
  const resetBtn = $('resetBtn');

  // State
  let currentPool = [];
  let lastWinners = [];

  // Parse names from textarea
  function parseNames(text){
    if(!text) return [];
    // split by newlines and commas/semicolons
    const raw = text.split(/\r?\n|,|;/).map(s => s.trim());
    const filtered = raw.filter(s => s !== '');
    // if excludeBlank checked, already filtered; otherwise keep blanks (but usually we want to remove)
    return filtered;
  }

  function readPool(){
    const arr = parseNames(namesInput.value);
    // optionally exclude blanks (parseNames already removed blanks)
    return arr;
  }

  // Fisher-Yates shuffle
  function shuffle(array){
    let a = array.slice();
    for(let i=a.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  function pick(pool, n, unique=true){
    if(n<=0) return [];
    if(pool.length===0) return [];
    if(unique){
      const limit = Math.min(n, pool.length);
      const s = shuffle(pool);
      return s.slice(0, limit);
    } else {
      // allow duplicates
      const res = [];
      for(let i=0;i<n;i++){ res.push(pool[Math.floor(Math.random()*pool.length)]); }
      return res;
    }
  }

  function displaySlots(n){
    slots.innerHTML='';
    for(let i=0;i<n;i++){
      const div = document.createElement('div');
      div.className='animated-slot';
      div.textContent='— 抽签槽 ' + (i+1);
      slots.appendChild(div);
    }
  }

  function animateReveal(names, duration=1200){
    // names: array of winners
    const slotEls = Array.from(slots.children);
    winnersDiv.innerHTML='';
    lastWinners = [];

    // For each slot, cycle through random names then reveal
    const pool = readPool();
    slotEls.forEach((el, idx) => {
      let rounds = 18; // number of flickers
      const interval = Math.max(20, duration / rounds);
      let r=0;
      const timer = setInterval(()=>{
        el.textContent = pool[Math.floor(Math.random()*pool.length)] || '—';
        r++;
        if(r>=rounds){ clearInterval(timer); el.textContent = names[idx] || '—';
          const pill = document.createElement('span'); pill.className='winner-pill'; pill.textContent=(idx+1)+'. '+(names[idx]||'—');
          winnersDiv.appendChild(pill);
          lastWinners.push(names[idx]||'');
        }
      }, interval);
    });
  }

  // Actions
  importCsvBtn.addEventListener('click', ()=>{
    if(!csvFile.files || csvFile.files.length===0){ alert('请先选择 CSV 文件 (或直接粘贴名单在左侧)'); return; }
    const f = csvFile.files[0];
    const reader = new FileReader();
    reader.onload = function(e){
      const txt = e.target.result;
      // take first column of each line if comma-separated
      const lines = txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const parsed = lines.map(l=>{
        const cols = l.split(/,|;/);
        return cols[0].trim();
      }).filter(Boolean);
      // append to textarea
      const existing = namesInput.value.trim();
      namesInput.value = (existing ? existing + '\n' : '') + parsed.join('\n');
      log('已从 CSV 导入 ' + parsed.length + ' 个名字');
    };
    reader.readAsText(f,'utf-8');
  });

  clearNamesBtn.addEventListener('click', ()=>{ if(confirm('确认清空所有已输入的名字？')){ namesInput.value=''; log('已清空名单'); } });

  previewBtn.addEventListener('click', ()=>{
    const arr = readPool();
    alert('名单预览（共 '+arr.length+'）：\n' + arr.slice(0,500).join('\n'));
  });

  exportAllBtn.addEventListener('click', ()=>{
    const arr = readPool();
    if(arr.length===0){ alert('名单为空'); return; }
    const csv = arr.map(r => '"'+r.replace(/"/g,'""')+'"').join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='names_export.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    log('已导出全部名单（'+arr.length+'）');
  });

  drawBtn.addEventListener('click', ()=>{
    const pool = readPool().filter(Boolean);
    if(pool.length===0){ alert('名单为空，请先输入或导入名字'); return; }
    const n = Math.max(1, parseInt(countInput.value)||1);
    const unique = (uniqueSelect.value === 'true');
    if(unique && n>pool.length){
      if(!confirm('抽取人数超出去重后的名单数量（'+pool.length+'）。是否改为只抽取 '+pool.length+' 人？按 OK 确认。')){ return; }
    }

    // Determine actual number to draw
    const actualN = unique ? Math.min(n, pool.length) : n;
    displaySlots(actualN);
    const drawPool = shuffleBefore.checked ? shuffle(pool) : pool.slice();
    // pick winners
    const winners = pick(drawPool, actualN, unique);
    log('开始抽签，目标人数：' + n + '，实际抽取：' + actualN + '，去重：' + unique);
    animateReveal(winners, 1200);
  });

  copyBtn.addEventListener('click', ()=>{
    if(lastWinners.length===0){ alert('还没有抽取结果'); return; }
    navigator.clipboard?.writeText(lastWinners.join('\n'))
      .then(()=>{ alert('已复制到剪贴板'); log('结果已复制'); })
      .catch(()=>{ prompt('请手动复制以下结果：', lastWinners.join('\n')); });
  });

  exportWinnersBtn.addEventListener('click', ()=>{
    if(lastWinners.length===0){ alert('还没有抽取结果'); return; }
    const csv = lastWinners.map(r=>'"'+(r||'').replace(/"/g,'""')+'"').join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='winners.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    log('已导出中奖名单（'+lastWinners.length+'）');
  });

  resetBtn.addEventListener('click', ()=>{
    if(confirm('确认重置抽奖（保留名单）？')){ slots.innerHTML=''; winnersDiv.innerHTML=''; lastWinners=[]; log('已重置抽奖显示'); }
  });

  // initialize
  namesInput.placeholder = '在这里粘贴或输入名单，每行一个名字。也支持使用逗号/分号分隔。\n例如：\n张三\n李四\n王五';
  log('页面已就绪');
})();
</script>
</body>
</html>
